{"ast":null,"code":"import { socket } from \"./socket\";\nlet localStream = null;\nlet audioContext = null;\nlet analyser = null;\nlet speaking = false;\nexport async function startCall(onRemoteStream) {\n  localStream = await navigator.mediaDevices.getUserMedia({\n    audio: true\n  });\n  audioContext = new AudioContext();\n  const source = audioContext.createMediaStreamSource(localStream);\n  analyser = audioContext.createAnalyser();\n  analyser.fftSize = 512;\n  source.connect(analyser);\n  detectSpeaking();\n  return localStream;\n}\nfunction detectSpeaking() {\n  const data = new Uint8Array(analyser.frequencyBinCount);\n  function loop() {\n    analyser.getByteFrequencyData(data);\n    const volume = data.reduce((a, b) => a + b) / data.length;\n    if (volume > 25 && !speaking) {\n      speaking = true;\n      socket.emit(\"speakingStart\", {\n        channel: localStorage.getItem(\"voiceChannel\"),\n        user: localStorage.getItem(\"username\")\n      });\n    }\n    if (volume < 15 && speaking) {\n      speaking = false;\n      socket.emit(\"speakingStop\", {\n        channel: localStorage.getItem(\"voiceChannel\"),\n        user: localStorage.getItem(\"username\")\n      });\n    }\n    requestAnimationFrame(loop);\n  }\n  loop();\n}\nexport function muteLocalAudio() {\n  localStream.getAudioTracks().forEach(t => t.enabled = false);\n}\nexport function unmuteLocalAudio() {\n  localStream.getAudioTracks().forEach(t => t.enabled = true);\n}\nexport function isLocalMuted() {\n  return localStream && !localStream.getAudioTracks()[0].enabled;\n}","map":{"version":3,"names":["socket","localStream","audioContext","analyser","speaking","startCall","onRemoteStream","navigator","mediaDevices","getUserMedia","audio","AudioContext","source","createMediaStreamSource","createAnalyser","fftSize","connect","detectSpeaking","data","Uint8Array","frequencyBinCount","loop","getByteFrequencyData","volume","reduce","a","b","length","emit","channel","localStorage","getItem","user","requestAnimationFrame","muteLocalAudio","getAudioTracks","forEach","t","enabled","unmuteLocalAudio","isLocalMuted"],"sources":["C:/Users/ericb/mini-discord/frontend/src/webrtc.js"],"sourcesContent":["import { socket } from \"./socket\";\r\n\r\nlet localStream = null;\r\nlet audioContext = null;\r\nlet analyser = null;\r\nlet speaking = false;\r\n\r\nexport async function startCall(onRemoteStream) {\r\n  localStream = await navigator.mediaDevices.getUserMedia({ audio: true });\r\n\r\n  audioContext = new AudioContext();\r\n  const source = audioContext.createMediaStreamSource(localStream);\r\n  analyser = audioContext.createAnalyser();\r\n  analyser.fftSize = 512;\r\n  source.connect(analyser);\r\n\r\n  detectSpeaking();\r\n\r\n  return localStream;\r\n}\r\n\r\nfunction detectSpeaking() {\r\n  const data = new Uint8Array(analyser.frequencyBinCount);\r\n\r\n  function loop() {\r\n    analyser.getByteFrequencyData(data);\r\n    const volume = data.reduce((a, b) => a + b) / data.length;\r\n\r\n    if (volume > 25 && !speaking) {\r\n      speaking = true;\r\n      socket.emit(\"speakingStart\", {\r\n        channel: localStorage.getItem(\"voiceChannel\"),\r\n        user: localStorage.getItem(\"username\")\r\n      });\r\n    }\r\n\r\n    if (volume < 15 && speaking) {\r\n      speaking = false;\r\n      socket.emit(\"speakingStop\", {\r\n        channel: localStorage.getItem(\"voiceChannel\"),\r\n        user: localStorage.getItem(\"username\")\r\n      });\r\n    }\r\n\r\n    requestAnimationFrame(loop);\r\n  }\r\n\r\n  loop();\r\n}\r\n\r\nexport function muteLocalAudio() {\r\n  localStream.getAudioTracks().forEach(t => t.enabled = false);\r\n}\r\n\r\nexport function unmuteLocalAudio() {\r\n  localStream.getAudioTracks().forEach(t => t.enabled = true);\r\n}\r\n\r\nexport function isLocalMuted() {\r\n  return localStream && !localStream.getAudioTracks()[0].enabled;\r\n}\r\n"],"mappings":"AAAA,SAASA,MAAM,QAAQ,UAAU;AAEjC,IAAIC,WAAW,GAAG,IAAI;AACtB,IAAIC,YAAY,GAAG,IAAI;AACvB,IAAIC,QAAQ,GAAG,IAAI;AACnB,IAAIC,QAAQ,GAAG,KAAK;AAEpB,OAAO,eAAeC,SAASA,CAACC,cAAc,EAAE;EAC9CL,WAAW,GAAG,MAAMM,SAAS,CAACC,YAAY,CAACC,YAAY,CAAC;IAAEC,KAAK,EAAE;EAAK,CAAC,CAAC;EAExER,YAAY,GAAG,IAAIS,YAAY,CAAC,CAAC;EACjC,MAAMC,MAAM,GAAGV,YAAY,CAACW,uBAAuB,CAACZ,WAAW,CAAC;EAChEE,QAAQ,GAAGD,YAAY,CAACY,cAAc,CAAC,CAAC;EACxCX,QAAQ,CAACY,OAAO,GAAG,GAAG;EACtBH,MAAM,CAACI,OAAO,CAACb,QAAQ,CAAC;EAExBc,cAAc,CAAC,CAAC;EAEhB,OAAOhB,WAAW;AACpB;AAEA,SAASgB,cAAcA,CAAA,EAAG;EACxB,MAAMC,IAAI,GAAG,IAAIC,UAAU,CAAChB,QAAQ,CAACiB,iBAAiB,CAAC;EAEvD,SAASC,IAAIA,CAAA,EAAG;IACdlB,QAAQ,CAACmB,oBAAoB,CAACJ,IAAI,CAAC;IACnC,MAAMK,MAAM,GAAGL,IAAI,CAACM,MAAM,CAAC,CAACC,CAAC,EAAEC,CAAC,KAAKD,CAAC,GAAGC,CAAC,CAAC,GAAGR,IAAI,CAACS,MAAM;IAEzD,IAAIJ,MAAM,GAAG,EAAE,IAAI,CAACnB,QAAQ,EAAE;MAC5BA,QAAQ,GAAG,IAAI;MACfJ,MAAM,CAAC4B,IAAI,CAAC,eAAe,EAAE;QAC3BC,OAAO,EAAEC,YAAY,CAACC,OAAO,CAAC,cAAc,CAAC;QAC7CC,IAAI,EAAEF,YAAY,CAACC,OAAO,CAAC,UAAU;MACvC,CAAC,CAAC;IACJ;IAEA,IAAIR,MAAM,GAAG,EAAE,IAAInB,QAAQ,EAAE;MAC3BA,QAAQ,GAAG,KAAK;MAChBJ,MAAM,CAAC4B,IAAI,CAAC,cAAc,EAAE;QAC1BC,OAAO,EAAEC,YAAY,CAACC,OAAO,CAAC,cAAc,CAAC;QAC7CC,IAAI,EAAEF,YAAY,CAACC,OAAO,CAAC,UAAU;MACvC,CAAC,CAAC;IACJ;IAEAE,qBAAqB,CAACZ,IAAI,CAAC;EAC7B;EAEAA,IAAI,CAAC,CAAC;AACR;AAEA,OAAO,SAASa,cAAcA,CAAA,EAAG;EAC/BjC,WAAW,CAACkC,cAAc,CAAC,CAAC,CAACC,OAAO,CAACC,CAAC,IAAIA,CAAC,CAACC,OAAO,GAAG,KAAK,CAAC;AAC9D;AAEA,OAAO,SAASC,gBAAgBA,CAAA,EAAG;EACjCtC,WAAW,CAACkC,cAAc,CAAC,CAAC,CAACC,OAAO,CAACC,CAAC,IAAIA,CAAC,CAACC,OAAO,GAAG,IAAI,CAAC;AAC7D;AAEA,OAAO,SAASE,YAAYA,CAAA,EAAG;EAC7B,OAAOvC,WAAW,IAAI,CAACA,WAAW,CAACkC,cAAc,CAAC,CAAC,CAAC,CAAC,CAAC,CAACG,OAAO;AAChE","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}