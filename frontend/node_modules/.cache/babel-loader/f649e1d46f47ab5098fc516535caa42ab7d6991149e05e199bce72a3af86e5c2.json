{"ast":null,"code":"import { socket } from \"./socket\";\nlet localStream = null;\nlet audioContext = null;\nlet analyser = null;\nlet speaking = false;\nexport async function startCall() {\n  localStream = await navigator.mediaDevices.getUserMedia({\n    audio: true\n  });\n  audioContext = new AudioContext();\n  const source = audioContext.createMediaStreamSource(localStream);\n  analyser = audioContext.createAnalyser();\n  analyser.fftSize = 512;\n  source.connect(analyser);\n  detectSpeaking();\n  return localStream;\n}\nexport function stopCall() {\n  if (localStream) {\n    localStream.getTracks().forEach(t => t.stop());\n    localStream = null;\n  }\n  if (audioContext) {\n    audioContext.close();\n    audioContext = null;\n  }\n  speaking = false;\n}\nfunction detectSpeaking() {\n  const data = new Uint8Array(analyser.frequencyBinCount);\n  function loop() {\n    if (!analyser) return;\n    analyser.getByteFrequencyData(data);\n    const volume = data.reduce((a, b) => a + b) / data.length;\n    if (volume > 25 && !speaking) {\n      speaking = true;\n      socket.emit(\"speakingStart\", {\n        channel: localStorage.getItem(\"voiceChannel\"),\n        user: localStorage.getItem(\"username\")\n      });\n    }\n    if (volume < 15 && speaking) {\n      speaking = false;\n      socket.emit(\"speakingStop\", {\n        channel: localStorage.getItem(\"voiceChannel\"),\n        user: localStorage.getItem(\"username\")\n      });\n    }\n    requestAnimationFrame(loop);\n  }\n  loop();\n}","map":{"version":3,"names":["socket","localStream","audioContext","analyser","speaking","startCall","navigator","mediaDevices","getUserMedia","audio","AudioContext","source","createMediaStreamSource","createAnalyser","fftSize","connect","detectSpeaking","stopCall","getTracks","forEach","t","stop","close","data","Uint8Array","frequencyBinCount","loop","getByteFrequencyData","volume","reduce","a","b","length","emit","channel","localStorage","getItem","user","requestAnimationFrame"],"sources":["C:/Users/ericb/mini-discord/frontend/src/webrtc.js"],"sourcesContent":["import { socket } from \"./socket\";\r\n\r\nlet localStream = null;\r\nlet audioContext = null;\r\nlet analyser = null;\r\nlet speaking = false;\r\n\r\nexport async function startCall() {\r\n  localStream = await navigator.mediaDevices.getUserMedia({ audio: true });\r\n\r\n  audioContext = new AudioContext();\r\n  const source = audioContext.createMediaStreamSource(localStream);\r\n  analyser = audioContext.createAnalyser();\r\n  analyser.fftSize = 512;\r\n  source.connect(analyser);\r\n\r\n  detectSpeaking();\r\n\r\n  return localStream;\r\n}\r\n\r\nexport function stopCall() {\r\n  if (localStream) {\r\n    localStream.getTracks().forEach((t) => t.stop());\r\n    localStream = null;\r\n  }\r\n\r\n  if (audioContext) {\r\n    audioContext.close();\r\n    audioContext = null;\r\n  }\r\n\r\n  speaking = false;\r\n}\r\n\r\nfunction detectSpeaking() {\r\n  const data = new Uint8Array(analyser.frequencyBinCount);\r\n\r\n  function loop() {\r\n    if (!analyser) return;\r\n\r\n    analyser.getByteFrequencyData(data);\r\n    const volume = data.reduce((a, b) => a + b) / data.length;\r\n\r\n    if (volume > 25 && !speaking) {\r\n      speaking = true;\r\n      socket.emit(\"speakingStart\", {\r\n        channel: localStorage.getItem(\"voiceChannel\"),\r\n        user: localStorage.getItem(\"username\")\r\n      });\r\n    }\r\n\r\n    if (volume < 15 && speaking) {\r\n      speaking = false;\r\n      socket.emit(\"speakingStop\", {\r\n        channel: localStorage.getItem(\"voiceChannel\"),\r\n        user: localStorage.getItem(\"username\")\r\n      });\r\n    }\r\n\r\n    requestAnimationFrame(loop);\r\n  }\r\n\r\n  loop();\r\n}\r\n"],"mappings":"AAAA,SAASA,MAAM,QAAQ,UAAU;AAEjC,IAAIC,WAAW,GAAG,IAAI;AACtB,IAAIC,YAAY,GAAG,IAAI;AACvB,IAAIC,QAAQ,GAAG,IAAI;AACnB,IAAIC,QAAQ,GAAG,KAAK;AAEpB,OAAO,eAAeC,SAASA,CAAA,EAAG;EAChCJ,WAAW,GAAG,MAAMK,SAAS,CAACC,YAAY,CAACC,YAAY,CAAC;IAAEC,KAAK,EAAE;EAAK,CAAC,CAAC;EAExEP,YAAY,GAAG,IAAIQ,YAAY,CAAC,CAAC;EACjC,MAAMC,MAAM,GAAGT,YAAY,CAACU,uBAAuB,CAACX,WAAW,CAAC;EAChEE,QAAQ,GAAGD,YAAY,CAACW,cAAc,CAAC,CAAC;EACxCV,QAAQ,CAACW,OAAO,GAAG,GAAG;EACtBH,MAAM,CAACI,OAAO,CAACZ,QAAQ,CAAC;EAExBa,cAAc,CAAC,CAAC;EAEhB,OAAOf,WAAW;AACpB;AAEA,OAAO,SAASgB,QAAQA,CAAA,EAAG;EACzB,IAAIhB,WAAW,EAAE;IACfA,WAAW,CAACiB,SAAS,CAAC,CAAC,CAACC,OAAO,CAAEC,CAAC,IAAKA,CAAC,CAACC,IAAI,CAAC,CAAC,CAAC;IAChDpB,WAAW,GAAG,IAAI;EACpB;EAEA,IAAIC,YAAY,EAAE;IAChBA,YAAY,CAACoB,KAAK,CAAC,CAAC;IACpBpB,YAAY,GAAG,IAAI;EACrB;EAEAE,QAAQ,GAAG,KAAK;AAClB;AAEA,SAASY,cAAcA,CAAA,EAAG;EACxB,MAAMO,IAAI,GAAG,IAAIC,UAAU,CAACrB,QAAQ,CAACsB,iBAAiB,CAAC;EAEvD,SAASC,IAAIA,CAAA,EAAG;IACd,IAAI,CAACvB,QAAQ,EAAE;IAEfA,QAAQ,CAACwB,oBAAoB,CAACJ,IAAI,CAAC;IACnC,MAAMK,MAAM,GAAGL,IAAI,CAACM,MAAM,CAAC,CAACC,CAAC,EAAEC,CAAC,KAAKD,CAAC,GAAGC,CAAC,CAAC,GAAGR,IAAI,CAACS,MAAM;IAEzD,IAAIJ,MAAM,GAAG,EAAE,IAAI,CAACxB,QAAQ,EAAE;MAC5BA,QAAQ,GAAG,IAAI;MACfJ,MAAM,CAACiC,IAAI,CAAC,eAAe,EAAE;QAC3BC,OAAO,EAAEC,YAAY,CAACC,OAAO,CAAC,cAAc,CAAC;QAC7CC,IAAI,EAAEF,YAAY,CAACC,OAAO,CAAC,UAAU;MACvC,CAAC,CAAC;IACJ;IAEA,IAAIR,MAAM,GAAG,EAAE,IAAIxB,QAAQ,EAAE;MAC3BA,QAAQ,GAAG,KAAK;MAChBJ,MAAM,CAACiC,IAAI,CAAC,cAAc,EAAE;QAC1BC,OAAO,EAAEC,YAAY,CAACC,OAAO,CAAC,cAAc,CAAC;QAC7CC,IAAI,EAAEF,YAAY,CAACC,OAAO,CAAC,UAAU;MACvC,CAAC,CAAC;IACJ;IAEAE,qBAAqB,CAACZ,IAAI,CAAC;EAC7B;EAEAA,IAAI,CAAC,CAAC;AACR","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}