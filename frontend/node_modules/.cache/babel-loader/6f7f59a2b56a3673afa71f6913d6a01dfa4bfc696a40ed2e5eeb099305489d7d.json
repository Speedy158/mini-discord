{"ast":null,"code":"import { socket } from \"./socket\";\nconst peers = {};\nlet localStream = null;\nlet currentChannel = null;\nconst audioContext = new (window.AudioContext || window.webkitAudioContext)();\nlet analyser = null;\nlet speaking = false;\nexport async function joinVoiceChannel(channel) {\n  currentChannel = channel;\n  localStream = await navigator.mediaDevices.getUserMedia({\n    audio: true\n  });\n  setupVAD();\n  socket.emit(\"voice:join\", {\n    channel\n  });\n  return localStream;\n}\nexport function leaveVoiceChannel() {\n  Object.values(peers).forEach(pc => pc.close());\n  for (const id in peers) delete peers[id];\n  if (localStream) {\n    localStream.getTracks().forEach(t => t.stop());\n    localStream = null;\n  }\n  analyser = null;\n  speaking = false;\n  socket.emit(\"voice:leave\", {\n    channel: currentChannel\n  });\n  currentChannel = null;\n}\nexport function muteMic() {\n  if (!localStream) return;\n  localStream.getAudioTracks().forEach(t => t.enabled = false);\n}\nexport function unmuteMic() {\n  if (!localStream) return;\n  localStream.getAudioTracks().forEach(t => t.enabled = true);\n}\nfunction setupVAD() {\n  if (!localStream) return;\n  const source = audioContext.createMediaStreamSource(localStream);\n  analyser = audioContext.createAnalyser();\n  analyser.fftSize = 512;\n  source.connect(analyser);\n  detectSpeech();\n}\nfunction detectSpeech() {\n  if (!analyser) return;\n  const data = new Uint8Array(analyser.frequencyBinCount);\n  analyser.getByteFrequencyData(data);\n  const volume = data.reduce((a, b) => a + b, 0) / data.length;\n  const isSpeaking = volume > 20;\n  if (isSpeaking !== speaking) {\n    speaking = isSpeaking;\n    socket.emit(\"voice:speaking\", {\n      speaking\n    });\n  }\n  requestAnimationFrame(detectSpeech);\n}\nfunction createPeerConnection(targetId) {\n  const pc = new RTCPeerConnection({\n    iceServers: [{\n      urls: \"stun:stun.l.google.com:19302\"\n    }]\n  });\n  if (localStream) {\n    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));\n  }\n  pc.ontrack = event => {\n    const audio = document.getElementById(\"audio-\" + targetId);\n    if (audio) {\n      audio.srcObject = event.streams[0];\n      audio.play();\n    }\n  };\n  pc.onicecandidate = event => {\n    if (event.candidate) {\n      socket.emit(\"voice:ice-candidate\", {\n        target: targetId,\n        candidate: event.candidate\n      });\n    }\n  };\n  return pc;\n}\nsocket.on(\"voice:user-joined\", async ({\n  id,\n  channel\n}) => {\n  if (!localStream) return;\n  if (channel !== currentChannel) return;\n  const pc = createPeerConnection(id);\n  peers[id] = pc;\n  const offer = await pc.createOffer();\n  await pc.setLocalDescription(offer);\n  socket.emit(\"voice:offer\", {\n    target: id,\n    offer\n  });\n});\nsocket.on(\"voice:offer\", async ({\n  sender,\n  offer\n}) => {\n  if (!localStream) return;\n  const pc = createPeerConnection(sender);\n  peers[sender] = pc;\n  await pc.setRemoteDescription(new RTCSessionDescription(offer));\n  const answer = await pc.createAnswer();\n  await pc.setLocalDescription(answer);\n  socket.emit(\"voice:answer\", {\n    target: sender,\n    answer\n  });\n});\nsocket.on(\"voice:answer\", async ({\n  sender,\n  answer\n}) => {\n  const pc = peers[sender];\n  if (!pc) return;\n  await pc.setRemoteDescription(new RTCSessionDescription(answer));\n});\nsocket.on(\"voice:ice-candidate\", async ({\n  sender,\n  candidate\n}) => {\n  const pc = peers[sender];\n  if (!pc) return;\n  await pc.addIceCandidate(new RTCIceCandidate(candidate));\n});\nsocket.on(\"voice:user-left\", ({\n  id\n}) => {\n  if (peers[id]) {\n    peers[id].close();\n    delete peers[id];\n  }\n});","map":{"version":3,"names":["socket","peers","localStream","currentChannel","audioContext","window","AudioContext","webkitAudioContext","analyser","speaking","joinVoiceChannel","channel","navigator","mediaDevices","getUserMedia","audio","setupVAD","emit","leaveVoiceChannel","Object","values","forEach","pc","close","id","getTracks","t","stop","muteMic","getAudioTracks","enabled","unmuteMic","source","createMediaStreamSource","createAnalyser","fftSize","connect","detectSpeech","data","Uint8Array","frequencyBinCount","getByteFrequencyData","volume","reduce","a","b","length","isSpeaking","requestAnimationFrame","createPeerConnection","targetId","RTCPeerConnection","iceServers","urls","track","addTrack","ontrack","event","document","getElementById","srcObject","streams","play","onicecandidate","candidate","target","on","offer","createOffer","setLocalDescription","sender","setRemoteDescription","RTCSessionDescription","answer","createAnswer","addIceCandidate","RTCIceCandidate"],"sources":["C:/Users/ericb/mini-discord-client/src/webrtc.js"],"sourcesContent":["import { socket } from \"./socket\";\r\n\r\nconst peers = {};\r\nlet localStream = null;\r\nlet currentChannel = null;\r\n\r\nconst audioContext = new (window.AudioContext || window.webkitAudioContext)();\r\nlet analyser = null;\r\nlet speaking = false;\r\n\r\nexport async function joinVoiceChannel(channel) {\r\n  currentChannel = channel;\r\n\r\n  localStream = await navigator.mediaDevices.getUserMedia({ audio: true });\r\n\r\n  setupVAD();\r\n\r\n  socket.emit(\"voice:join\", { channel });\r\n\r\n  return localStream;\r\n}\r\n\r\nexport function leaveVoiceChannel() {\r\n  Object.values(peers).forEach((pc) => pc.close());\r\n  for (const id in peers) delete peers[id];\r\n\r\n  if (localStream) {\r\n    localStream.getTracks().forEach((t) => t.stop());\r\n    localStream = null;\r\n  }\r\n\r\n  analyser = null;\r\n  speaking = false;\r\n\r\n  socket.emit(\"voice:leave\", { channel: currentChannel });\r\n  currentChannel = null;\r\n}\r\n\r\nexport function muteMic() {\r\n  if (!localStream) return;\r\n  localStream.getAudioTracks().forEach((t) => (t.enabled = false));\r\n}\r\n\r\nexport function unmuteMic() {\r\n  if (!localStream) return;\r\n  localStream.getAudioTracks().forEach((t) => (t.enabled = true));\r\n}\r\n\r\nfunction setupVAD() {\r\n  if (!localStream) return;\r\n\r\n  const source = audioContext.createMediaStreamSource(localStream);\r\n  analyser = audioContext.createAnalyser();\r\n  analyser.fftSize = 512;\r\n  source.connect(analyser);\r\n\r\n  detectSpeech();\r\n}\r\n\r\nfunction detectSpeech() {\r\n  if (!analyser) return;\r\n\r\n  const data = new Uint8Array(analyser.frequencyBinCount);\r\n  analyser.getByteFrequencyData(data);\r\n\r\n  const volume = data.reduce((a, b) => a + b, 0) / data.length;\r\n  const isSpeaking = volume > 20;\r\n\r\n  if (isSpeaking !== speaking) {\r\n    speaking = isSpeaking;\r\n    socket.emit(\"voice:speaking\", { speaking });\r\n  }\r\n\r\n  requestAnimationFrame(detectSpeech);\r\n}\r\n\r\nfunction createPeerConnection(targetId) {\r\n  const pc = new RTCPeerConnection({\r\n    iceServers: [{ urls: \"stun:stun.l.google.com:19302\" }],\r\n  });\r\n\r\n  if (localStream) {\r\n    localStream.getTracks().forEach((track) => pc.addTrack(track, localStream));\r\n  }\r\n\r\n  pc.ontrack = (event) => {\r\n    const audio = document.getElementById(\"audio-\" + targetId);\r\n    if (audio) {\r\n      audio.srcObject = event.streams[0];\r\n      audio.play();\r\n    }\r\n  };\r\n\r\n  pc.onicecandidate = (event) => {\r\n    if (event.candidate) {\r\n      socket.emit(\"voice:ice-candidate\", {\r\n        target: targetId,\r\n        candidate: event.candidate,\r\n      });\r\n    }\r\n  };\r\n\r\n  return pc;\r\n}\r\n\r\nsocket.on(\"voice:user-joined\", async ({ id, channel }) => {\r\n  if (!localStream) return;\r\n  if (channel !== currentChannel) return;\r\n\r\n  const pc = createPeerConnection(id);\r\n  peers[id] = pc;\r\n\r\n  const offer = await pc.createOffer();\r\n  await pc.setLocalDescription(offer);\r\n\r\n  socket.emit(\"voice:offer\", { target: id, offer });\r\n});\r\n\r\nsocket.on(\"voice:offer\", async ({ sender, offer }) => {\r\n  if (!localStream) return;\r\n\r\n  const pc = createPeerConnection(sender);\r\n  peers[sender] = pc;\r\n\r\n  await pc.setRemoteDescription(new RTCSessionDescription(offer));\r\n\r\n  const answer = await pc.createAnswer();\r\n  await pc.setLocalDescription(answer);\r\n\r\n  socket.emit(\"voice:answer\", { target: sender, answer });\r\n});\r\n\r\nsocket.on(\"voice:answer\", async ({ sender, answer }) => {\r\n  const pc = peers[sender];\r\n  if (!pc) return;\r\n\r\n  await pc.setRemoteDescription(new RTCSessionDescription(answer));\r\n});\r\n\r\nsocket.on(\"voice:ice-candidate\", async ({ sender, candidate }) => {\r\n  const pc = peers[sender];\r\n  if (!pc) return;\r\n\r\n  await pc.addIceCandidate(new RTCIceCandidate(candidate));\r\n});\r\n\r\nsocket.on(\"voice:user-left\", ({ id }) => {\r\n  if (peers[id]) {\r\n    peers[id].close();\r\n    delete peers[id];\r\n  }\r\n});\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}